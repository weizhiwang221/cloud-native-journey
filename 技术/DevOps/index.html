<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://weizhiwang221.github.io/cloud-native-journey/%E6%8A%80%E6%9C%AF/DevOps/">
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>搭建企业级 DevOps 平台 - MengQiu Twenty-nine</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <link href="../../stylesheets/extra.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\u642d\u5efa\u4f01\u4e1a\u7ea7 DevOps \u5e73\u53f0", url: "#_top", children: [
              {title: "1\u3001\u73af\u5883\u51c6\u5907", url: "#1" },
              {title: "2\u3001\u5b89\u88c5Docker", url: "#2docker" },
              {title: "3\u3001\u5b89\u88c5gitlab", url: "#3gitlab" },
              {title: "4\u3001\u5b89\u88c5 Maven\u548cJDK17", url: "#4-mavenjdk17" },
              {title: "5\u3001\u5b89\u88c5Jenkins", url: "#5jenkins" },
              {title: "6\u3001\u5b89\u88c5\u63d2\u4ef6", url: "#6" },
              {title: "7\u3001\u5728Jenkins\u4e2d\u914d\u7f6eJDK\u548cmaven", url: "#7jenkinsjdkmaven" },
              {title: "8\u3001\u642d\u5efa\u672c\u5730\u73af\u5883", url: "#8" },
              {title: "9\u3001\u4f7f\u7528Jenkins\u62c9\u53d6gitlab\u4ee3\u7801", url: "#9jenkinsgitlab" },
              {title: "10\u3001\u5728\u62c9\u53d6gitlab\u4ee3\u7801\u7684\u540c\u65f6\uff0c\u63a8\u9001\u5230\u76ee\u6807\u670d\u52a1\u5668", url: "#10gitlab" },
              {title: "11\u3001Jenkins\u57fa\u4e8e\u53c2\u6570\u6784\u5efa", url: "#11jenkins" },
              {title: "12\u3001Jenkins\u5bb9\u5668\u5185\u90e8\u4f7f\u7528Docker", url: "#12jenkinsdocker" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Docker%20%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Docker%20%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="btn btn-xs btn-link">
        Docker 常用命令
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../.." class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../.." class="btn btn-xs btn-link">
        首页
      </a>
    </div>
    
  </div>

    

    <h1 id="devops">搭建企业级 DevOps 平台</h1>
<h2 id="1">1、环境准备</h2>
<table>
<thead>
<tr>
<th>主机名</th>
<th>主机IP</th>
<th>描述</th>
<th>操作系统</th>
<th>内核版本</th>
<th>机器配置</th>
</tr>
</thead>
<tbody>
<tr>
<td>gitlab-31-24</td>
<td>192.168.31.24</td>
<td>使用docker部署gitlab</td>
<td>Rocky Linux 9.0 (Blue Onyx)</td>
<td>Linux 5.14.0-70.13.1.el9_0.x86_64</td>
<td>8C 8G 100G</td>
</tr>
<tr>
<td>Jenkins-31-171</td>
<td>192.168.31.171</td>
<td>使用docker部署jenkins</td>
<td>Rocky Linux 9.0 (Blue Onyx)</td>
<td>Linux 5.14.0-70.13.1.el9_0.x86_64</td>
<td>4C 4G 100G</td>
</tr>
<tr>
<td>k8s-31-54</td>
<td>192.168.31.54</td>
<td>使用kubeadm部署k8s单节点集群</td>
<td>Rocky Linux 9.0 (Blue Onyx)</td>
<td>Linux 5.14.0-70.13.1.el9_0.x86_64</td>
<td>4C 4G 100G</td>
</tr>
</tbody>
</table>
<h3 id="_1">前置条件</h3>
<p>关闭防火墙和selinux</p>
<pre><code class="language-shell">systemctl disable firewalld.service --now
sed -i 's@SELINUX=enabled@SELINUX=disabled@g' /etc/selinux/config
# 重启生效所以临时设置为宽容模式
setenforce 0
reboot
</code></pre>
<p>因为虚拟机采用的网络模式是桥接，为了防止IP自动分配，请手动设置IP地址。三台同样配置</p>
<pre><code class="language-shell"># Rocky 操作系统使用NetworkManager管理网卡，编辑网卡文件
vim /etc/NetworkManager/system-connections/ens33.nmconnection
[connection]
id=ens33
uuid=22b59732-7826-371f-8b8d-f20c5d47bcce
type=ethernet
autoconnect-priority=-999
interface-name=ens33
timestamp=1755509104

[ethernet]

[ipv4]
method=manual  # auto改为 manual，注意后面不能有空格
address=192.168.31.54/24,192.168.31.1  # IP地址/子网掩码,网关，注意后面不能有空格
dns=8.8.8.8  # DNS服务器，注意后面不能有空格

[ipv6]
addr-gen-mode=eui64
method=auto

[proxy]


# 保存退出，并重启网卡
nmcli connection reload &amp;&amp; nmcli connection down ens33 &amp;&amp; nmcli connection up ens33
</code></pre>
<h3 id="_2">部署目录</h3>
<pre><code class="language-shell">/usr/local/
</code></pre>
<h3 id="_3">软件版本</h3>
<table>
<thead>
<tr>
<th>组件</th>
<th>推荐版本</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>GitLab CE</strong></td>
<td><code>17.5.0-ce.0</code></td>
<td>你已经拉取的版本，当前 LTS，支持新功能和安全补丁。</td>
</tr>
<tr>
<td><strong>Jenkins</strong></td>
<td><code>2.462.3 LTS</code></td>
<td>Jenkins 官方 LTS 稳定分支，推荐企业用 LTS，而不是 weekly。</td>
</tr>
<tr>
<td><strong>Harbor</strong></td>
<td><code>2.11.0</code></td>
<td>最新稳定版，支持 OCI Artifact、Trivy 安全扫描，兼容 Docker 20+ 和 K8s 1.32。</td>
</tr>
<tr>
<td><strong>SonarQube</strong></td>
<td><code>10.6.0 LTS</code></td>
<td>长期支持版本，兼容 JDK 17+，适合和 Jenkins Pipeline 集成。</td>
</tr>
<tr>
<td><strong>Maven</strong></td>
<td><code>3.8.9</code></td>
<td>最新稳定版（不是 3.8.5，官方已更新到 3.8.8），修复了 3.8.5 的部分依赖解析问题。</td>
</tr>
<tr>
<td><strong>OpenJDK</strong></td>
<td><code>17</code> (LTS)</td>
<td>建议使用 JDK 17（目前的 LTS，支持到 2029），Maven 3.8.x、Jenkins、SonarQube 都兼容；不建议 JDK 21（太新，部分插件未完全适配）。</td>
</tr>
<tr>
<td><strong>Kubernetes</strong></td>
<td><code>1.32.8</code></td>
<td>你已安装，属最新稳定分支。</td>
</tr>
<tr>
<td><strong>Docker CE</strong></td>
<td><code>28.3.3</code></td>
<td>你已安装，OK。</td>
</tr>
<tr>
<td><strong>docker-compose</strong></td>
<td><code>v2.27.0</code></td>
<td>你已安装，OK。</td>
</tr>
</tbody>
</table>
<h2 id="2docker">2、安装Docker</h2>
<h3 id="yum">配置YUM源</h3>
<ol>
<li>配置yum源</li>
</ol>
<pre><code class="language-bash">（1）确认文件是否存在且可读
sudo cat /etc/yum.repos.d/rocky.repo
如果文件不存在或内容为空，重新创建它。

（2）重新下载正确的阿里云源文件
sudo rm -f /etc/yum.repos.d/rocky.repo  # 删除旧文件（如果有）
sudo curl -o /etc/yum.repos.d/rocky.repo https://mirrors.aliyun.com/rockylinux/rocky.repo?repo=rocky-9
（3）手动编辑文件（如果下载失败）
sudo vi /etc/yum.repos.d/rocky.repo
粘贴以下内容（阿里云 Rocky Linux 9 镜像源）：
[baseos]
name=Rocky Linux $releasever - BaseOS - Aliyun
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/BaseOS/$basearch/os/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-rockyofficial

[appstream]
name=Rocky Linux $releasever - AppStream - Aliyun
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/AppStream/$basearch/os/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-rockyofficial

[extras]
name=Rocky Linux $releasever - Extras - Aliyun
baseurl=https://mirrors.aliyun.com/rockylinux/$releasever/extras/$basearch/os/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-rockyofficial


（4）也可以直接替换yum源里的地址
sed -e 's|^mirrorlist=|#mirrorlist=|g' \
    -e 's|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g' \
    -i.bak \
    /etc/yum.repos.d/rocky*.repo
</code></pre>
<ol>
<li>强制替换变量为 Rocky Linux 9
确保 $releasever 和 $basearch 被正确解析：</li>
</ol>
<pre><code class="language-bash">sudo sed -i 's/$releasever/9/g' /etc/yum.repos.d/rocky.repo
sudo sed -i 's/$basearch/x86_64/g' /etc/yum.repos.d/rocky.repo  # 如果是 x86_64 架构
</code></pre>
<ol>
<li>导入 GPG 密钥</li>
</ol>
<p><code>bash
sudo rpm --import https://mirrors.aliyun.com/rockylinux/RPM-GPG-KEY-rockyofficial</code></p>
<ol>
<li>
<p>检查文件权限和格式
    （1）确保文件权限正确</p>
<p><code>bash
sudo chmod 644 /etc/yum.repos.d/rocky.repo</code></p>
</li>
</ol>
<p>（2）检查文件格式（避免 UTF-8 BOM 或 Windows 换行符）</p>
<pre><code>```bash
sudo dos2unix /etc/yum.repos.d/rocky.repo  # 如果是从 Windows 复制的文件
```

清除缓存并重新加载
</code></pre>
<p><code>bash
sudo dnf clean all
sudo dnf makecache</code></p>
<ol>
<li>验证仓库是否启用</li>
</ol>
<p><code>bash
sudo dnf repolist
正常输出应类似：
text
repo id                          repo name
baseos                           Rocky Linux 9 - BaseOS - Aliyun
appstream                        Rocky Linux 9 - AppStream - Aliyun
extras                           Rocky Linux 9 - Extras - Aliyun</code></p>
<p>在 Rocky Linux 9 中启用并安装 EPEL Repo。</p>
<pre><code class="language-sql">dnf install epel-release
</code></pre>
<p>备份(如有配置其他epel源)并替换为国内镜像
注意最后这个库，阿里云没有对应的镜像，不要修改它，如果误改恢复原版源即可</p>
<pre><code class="language-cobol">cp /etc/yum.repos.d/epel.repo  /etc/yum.repos.d/epel.repo.backup 
cp /etc/yum.repos.d/epel-testing.repo  /etc/yum.repos.d/epel-testing.repo.backup
cp /etc/yum.repos.d/epel-cisco-openh264.repo  /etc/yum.repos.d/epel-cisco-openh264.repo.backup
</code></pre>
<p>将 repo 配置中的地址替换为阿里云镜像站地址</p>
<p>执行下面语句，它会替换epel.repo、eple-testing.repo中的网址，不会修改epel-cisco-openh264.repo，可以正常使用。</p>
<pre><code class="language-cobol">sed -e 's!^metalink=!#metalink=!g' \
    -e 's!^#baseurl=!baseurl=!g' \
    -e 's!https\?://download\.fedoraproject\.org/pub/epel!https://mirrors.aliyun.com/epel!g' \
    -e 's!https\?://download\.example/pub/epel!https://mirrors.aliyun.com/epel!g' \
    -i /etc/yum.repos.d/epel{,-testing}.repo
</code></pre>
<p>更新仓库缓存</p>
<pre><code class="language-sql">dnf clean all 
dnf makecache   ---生成缓存，安装软件更快
</code></pre>
<h3 id="docker">查看docker版本</h3>
<pre><code class="language-shell"># Step 1: 安装依赖
yum install -y yum-utils device-mapper-persistent-data lvm2

# Step 2: 添加软件源信息
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/rhel/docker-ce.repo

# Step 3: 安装Docker-CE，查询安装的版本
dnf list docker-ce --showduplicates | sort -r

docker-ce.x86_64                 3:28.3.3-1.el9                 docker-ce-stable
docker-ce.x86_64                 3:28.3.2-1.el9                 docker-ce-stable
docker-ce.x86_64                 3:28.3.1-1.el9                 docker-ce-stable
docker-ce.x86_64                 3:28.3.0-1.el9                 docker-ce-stable

# dnf install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.io docker-buildx-plugin docker-compose-plugin
dnf install docker-ce-28.3.3 docker-ce-cli-28.3.3 containerd.io docker-buildx-plugin docker-compose-plugin -y

# docker -v
Docker version 28.3.3, build 980b856

# 设置国内镜像加速
mkdir -p /etc/docker/ 
cat  &gt;&gt; /etc/docker/daemon.json &lt;&lt; EOF
{
   &quot;registry-mirrors&quot;:[&quot;https://p3kgr6db.mirror.aliyuncs.com&quot;,
   &quot;https://docker.m.daocloud.io&quot;,
   &quot;https://your_id.mirror.aliyuncs.com&quot;,
   &quot;https://docker.nju.edu.cn/&quot;,
    &quot;https://docker.anyhub.us.kg&quot;,
    &quot;https://dockerhub.jobcher.com&quot;,
    &quot;https://dockerhub.icu&quot;,
    &quot;https://docker.ckyl.me&quot;,
       &quot;https://cr.console.aliyun.com&quot;
   ],
&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]
}
EOF


# 设置docker开机启动并启动
systemctl daemon-reload
systemctl restart docker
systemctl enable --now docker

# 查看docker版本
[root@gitlab-31-24 ~]# docker version
Client: Docker Engine - Community
 Version:           28.3.3
 API version:       1.51
 Go version:        go1.24.5
 Git commit:        980b856
 Built:             Fri Jul 25 11:36:28 2025
 OS/Arch:           linux/amd64
 Context:           default

Server: Docker Engine - Community
 Engine:
  Version:          28.3.3
  API version:      1.51 (minimum version 1.24)
  Go version:       go1.24.5
  Git commit:       bea959c
  Built:            Fri Jul 25 11:33:28 2025
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.7.27
  GitCommit:        05044ec0a9a75232cad458027ca83437aae3f4da
 runc:
  Version:          1.2.5
  GitCommit:        v1.2.5-0-g59923ef
 docker-init:
  Version:          0.19.0
  GitCommit:        de40ad0

</code></pre>
<h3 id="docker-compose">安装docker-compose</h3>
<pre><code class="language-shell"># 从github上下载包，上传到服务器的/usr/local/bin/下
https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-x86_64

mv /usr/local/bin/docker-compose-linux-x86_64 /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
docker-compose version
Docker Compose version v2.27.0
</code></pre>
<h2 id="3gitlab">3、安装gitlab</h2>
<ul>
<li>拉取gitlab镜像</li>
</ul>
<pre><code class="language-shell">docker pull gitlab/gitlab-ce:17.5.0-ce.0
</code></pre>
<ul>
<li>创建安装目录，并创建docker-compose.yaml文件</li>
</ul>
<pre><code class="language-shell">mkdir -p /usr/local/docker/docker_gitlab
cd /usr/local/docker/docker_gitlab
vim docker-compose.yaml
services:
  gitlab:
    image: 'gitlab/gitlab-ce:17.5.0-ce.0'
    container_name: gitlab
    restart: always
    hostname: '192.168.31.24'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://192.168.31.24:8929'
        gitlab_rails['gitlab_shell_ssh_port'] = 2224
    ports:
      - '8929:8929'
      - '2224:22'
    volumes:
      - './config:/etc/gitlab'
      - './logs:/var/log/gitlab'
      - './data:/var/opt/gitlab'


docker-compose up -d                   
# 启动成功后，浏览器访问http://192.168.31.24:8929 如果出现502需要在多等一会，gitlab启动成功
</code></pre>
<ul>
<li>查看gitlab密码</li>
</ul>
<pre><code class="language-shell"># 进入gitlab 容器内部查看密码
docker exec -it gitlab bash

root@192:/# cat /etc/gitlab/initial_root_password
# WARNING: This value is valid only in the following conditions
#          1. If provided manually (either via `GITLAB_ROOT_PASSWORD` environment variable or via `gitlab_rails['initial_root_password']` setting in `gitlab.rb`, it was provided before database was seeded for the first time (usually, the first reconfigure run).
#          2. Password hasn't been changed manually, either via UI or via command line.
#
#          If the password shown here doesn't work, you must reset the admin password following https://docs.gitlab.com/ee/security/reset_user_password.html#reset-your-root-password.

Password: QeAKBSuBxlrGG0tbksCAIOAErunmqNb2DG99zFNGdck=

# NOTE: This file will be automatically deleted in the first reconfigure run after 24 hours.
root@192:/#

</code></pre>
<p><img alt="image-20250828105702230" src="../DevOps.assets/image-20250828105702230.png" /></p>
<h2 id="4-mavenjdk17">4、安装 Maven和JDK17</h2>
<p>Maven下载地址：<code>https://dlcdn.apache.org/maven/maven-3/3.8.9/binaries/apache-maven-3.8.9-bin.tar.gz</code></p>
<p>JDK17下载地址：<code>https://download.oracle.com/java/17/archive/jdk-17_linux-x64_bin.tar.gz</code></p>
<h3 id="_4">上传部署包到目标服务器</h3>
<pre><code class="language-shell"># 放到root目录下
[root@jenkins-31-171 local]# ls -ltr /root/
总用量 184436
-rw-r--r--  1 root root 180555480  8月 28 11:20 jdk-17_linux-x64_bin.tar.gz
-rw-r--r--  1 root root   8296518  8月 28 11:23 apache-maven-3.8.9-bin.tar.gz

# 解压并改名
tar -zxvf apache-maven-3.8.9-bin.tar.gz -C /usr/local/
tar -zxvf jdk-17_linux-x64_bin.tar.gz -C /usr/local/
cd /usr/local/
mv jdk-17/ jdk
mv apache-maven-3.8.9/ maven

</code></pre>
<h3 id="maven">配置maven的仓库地址</h3>
<pre><code class="language-shell"># 配置文件
vim /usr/local/maven/conf/settings.xml
    &lt;mirror&gt;
      &lt;id&gt;aliyunmaven&lt;/id&gt;
      &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;
      &lt;name&gt;阿里云公共仓库&lt;/name&gt;
      &lt;url&gt;https://maven.aliyun.com/repository/public&lt;/url&gt;
    &lt;/mirror&gt;

</code></pre>
<h3 id="java-jdk">配置Java JDK</h3>
<pre><code class="language-shell"># 配置文件
vim /usr/local/maven/conf/settings.xml
    &lt;profile&gt;
       &lt;id&gt;jdk17&lt;/id&gt;
       &lt;activation&gt;
           &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;
           &lt;jdk&gt;17&lt;/jdk&gt;
       &lt;/activation&gt;
       &lt;properties&gt;
          &lt;maven.compiler.source&gt;17&lt;/maven.compiler.source&gt;
          &lt;maven.compiler.target&gt;17&lt;/maven.compiler.target&gt;
          &lt;maven.compiler.compilerVersion&gt;17&lt;/maven.compiler.compilerVersion&gt;
       &lt;/properties&gt;
    &lt;/profile&gt;
  &lt;/profiles&gt;

  &lt;!-- activeProfiles
   | List of profiles that are active for all builds.
   |
  &lt;activeProfiles&gt;
    &lt;activeProfile&gt;alwaysActiveProfile&lt;/activeProfile&gt;
    &lt;activeProfile&gt;anotherAlwaysActiveProfile&lt;/activeProfile&gt;
  &lt;/activeProfiles&gt;
  --&gt;
  &lt;activeProfiles&gt;
    &lt;activeProfile&gt;jdk17&lt;/activeProfile&gt;
  &lt;/activeProfiles&gt;

</code></pre>
<h2 id="5jenkins">5、安装Jenkins</h2>
<ul>
<li>登录官网Jenkins.io上下载对应的Jenkins镜像</li>
</ul>
<pre><code class="language-shell">docker pull jenkins/jenkins:2.462.3-lts
</code></pre>
<ul>
<li>使用docker-compose部署Jenkins</li>
</ul>
<pre><code class="language-shell">mkdir -p  /usr/local/docker/jenkins_docker
cd /usr/local/docker/jenkins_docker
vim docker-compose.yaml
services:
  jenkins:
    image: jenkins/jenkins:2.462.3-lts
    container_name: jenkins
    ports:
      - 8080:8080
      - 50000:50000
    volumes:
      - ./data/:/var/jenkins_home/

[root@jenkins-31-171 jenkins_docker]# docker-compose up -d
[+] Running 2/2
 ✔ Network jenkins_docker_default  Created                                                                                                                                       0.0s
 ✔ Container jenkins               Started                                                                                                                                       0.3s
[root@jenkins-31-171 jenkins_docker]# docker logs -f jenkins
INSTALL WARNING: User:  missing rw permissions on JENKINS_HOME: /var/jenkins_home
touch: cannot touch '/var/jenkins_home/copy_reference_file.log': Permission denied
Can not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions?
[root@jenkins-31-171 jenkins_docker]# ls -tlr
总用量 4
-rw-r--r-- 1 root root 185  8月 28 11:51 docker-compose.yaml
drwxr-xr-x 2 root root   6  8月 28 11:51 data
[root@jenkins-31-171 jenkins_docker]# chmod -R  777 data
[root@jenkins-31-171 jenkins_docker]# docker-compose up -d
[root@jenkins-31-171 jenkins_docker]# docker logs -f jenkins
INSTALL WARNING: User:  missing rw permissions on JENKINS_HOME: /var/jenkins_home
touch: cannot touch '/var/jenkins_home/copy_reference_file.log': Permission denied
Can not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions?
Running from: /usr/share/jenkins/jenkins.war
webroot: /var/jenkins_home/war
2025-08-28 03:52:19.721+0000 [id=1]     INFO    winstone.Logger#logInternal: Beginning extraction from war file
2025-08-28 03:52:20.611+0000 [id=1]     WARNING o.e.j.s.handler.ContextHandler#setContextPath: Empty contextPath
2025-08-28 03:52:20.664+0000 [id=1]     INFO    org.eclipse.jetty.server.Server#doStart: jetty-10.0.24; built: 2024-08-26T17:58:21.070Z; git: d5384207795da96fad32db8ea8d26b69955bcc03; jvm 17.0.12+7
2025-08-28 03:52:21.016+0000 [id=1]     INFO    o.e.j.w.StandardDescriptorProcessor#visitServlet: NO JSP Support for /, did not find org.eclipse.jetty.jsp.JettyJspServlet
2025-08-28 03:52:21.050+0000 [id=1]     INFO    o.e.j.s.s.DefaultSessionIdManager#doStart: Session workerName=node0
2025-08-28 03:52:21.538+0000 [id=1]     INFO    hudson.WebAppMain#contextInitialized: Jenkins home directory: /var/jenkins_home found at: EnvVars.masterEnvVars.get(&quot;JENKINS_HOME&quot;)
2025-08-28 03:52:21.655+0000 [id=1]     INFO    o.e.j.s.handler.ContextHandler#doStart: Started w.@58860997{Jenkins v2.462.3,/,file:///var/jenkins_home/war/,AVAILABLE}{/var/jenkins_home/war}
2025-08-28 03:52:21.670+0000 [id=1]     INFO    o.e.j.server.AbstractConnector#doStart: Started ServerConnector@5c530d1e{HTTP/1.1, (http/1.1)}{0.0.0.0:8080}
2025-08-28 03:52:21.684+0000 [id=1]     INFO    org.eclipse.jetty.server.Server#doStart: Started Server@1c6804cd{STARTING}[10.0.24,sto=0] @2329ms
2025-08-28 03:52:21.686+0000 [id=26]    INFO    winstone.Logger#logInternal: Winstone Servlet Engine running: controlPort=disabled
2025-08-28 03:52:21.870+0000 [id=34]    INFO    jenkins.InitReactorRunner$1#onAttained: Started initialization
2025-08-28 03:52:21.888+0000 [id=35]    INFO    jenkins.InitReactorRunner$1#onAttained: Listed all plugins
2025-08-28 03:52:22.496+0000 [id=34]    INFO    jenkins.InitReactorRunner$1#onAttained: Prepared all plugins
2025-08-28 03:52:22.499+0000 [id=36]    INFO    jenkins.InitReactorRunner$1#onAttained: Started all plugins
2025-08-28 03:52:22.507+0000 [id=33]    INFO    jenkins.InitReactorRunner$1#onAttained: Augmented all extensions
2025-08-28 03:52:22.645+0000 [id=39]    INFO    jenkins.InitReactorRunner$1#onAttained: System config loaded
2025-08-28 03:52:22.645+0000 [id=39]    INFO    jenkins.InitReactorRunner$1#onAttained: System config adapted
2025-08-28 03:52:22.646+0000 [id=39]    INFO    jenkins.InitReactorRunner$1#onAttained: Loaded all jobs
2025-08-28 03:52:22.647+0000 [id=39]    INFO    jenkins.InitReactorRunner$1#onAttained: Configuration for all jobs updated
2025-08-28 03:52:22.675+0000 [id=52]    INFO    hudson.util.Retrier#start: Attempt #1 to do the action check updates server
2025-08-28 03:52:22.916+0000 [id=39]    INFO    jenkins.install.SetupWizard#init:

*************************************************************
*************************************************************
*************************************************************

Jenkins initial setup is required. An admin user has been created and a password generated.
Please use the following password to proceed to installation:

e0127ee5810548959b3b175c3fca7545

This may also be found at: /var/jenkins_home/secrets/initialAdminPassword

*************************************************************
*************************************************************
*************************************************************

2025-08-28 03:52:29.800+0000 [id=39]    INFO    jenkins.InitReactorRunner$1#onAttained: Completed initialization
2025-08-28 03:52:29.878+0000 [id=25]    INFO    hudson.lifecycle.Lifecycle#onReady: Jenkins is fully up and running
2025-08-28 03:52:31.681+0000 [id=52]    INFO    h.m.DownloadService$Downloadable#load: Obtained the updated data file for hudson.tasks.Maven.MavenInstaller
2025-08-28 03:52:31.682+0000 [id=52]    INFO    hudson.util.Retrier#start: Performed the action check updates server successfully at the attempt #1


</code></pre>
<ul>
<li>Jenkins密码在日志中  <code>e0127ee5810548959b3b175c3fca7545</code></li>
</ul>
<p><img alt="image-20250828115317547" src="../DevOps.assets/image-20250828115317547.png" /></p>
<blockquote>
<p>继续之后，选择-选择插件来安装-保持默认安装</p>
</blockquote>
<p><img alt="image-20250828115909157" src="../DevOps.assets/image-20250828115909157.png" /></p>
<p>http://192.168.31.171:8080/</p>
<h2 id="6">6、安装插件</h2>
<ol>
<li>Git Parameter</li>
<li>Publish Over SSH</li>
</ol>
<h2 id="7jenkinsjdkmaven">7、在Jenkins中配置JDK和maven</h2>
<pre><code class="language-shell">mv /usr/local/jdk /usr/local/docker/jenkins_docker/data/
mv /usr/local/maven /usr/local/docker/jenkins_docker/data/
</code></pre>
<p>在Jenkins的全局配置中，手动添加安装的JDK，JAVA_HOME 填写容器内的路径</p>
<p><img alt="image-20250828123732011" src="../DevOps.assets/image-20250828123732011.png" /></p>
<p>在Jenkins的全局配置中，手动添加安装的maven，MAVEN_HOME 填写容器内的路径</p>
<p><img alt="image-20250828123935744" src="../DevOps.assets/image-20250828123935744.png" /></p>
<p>在系统配置中，配置远端接收项目的服务器，采用root 密码的方式连接。填写目录时，必须先创建</p>
<p><img alt="image-20250828124414253" src="../DevOps.assets/image-20250828124414253.png" /></p>
<h2 id="8">8、搭建本地环境</h2>
<p>软件：vscode + maven + git</p>
<p>maven：<code>https://dlcdn.apache.org/maven/maven-3/3.9.11/binaries/apache-maven-3.9.11-bin.zip</code></p>
<p>git：<code>https://github.com/git-for-windows/git/releases/download/v2.51.0.windows.1/Git-2.51.0-64-bit.exe</code>  傻瓜式安装</p>
<p>详情请参考：<a href="https://blog.csdn.net/zyd573803837/article/details/109263219">超详细的VsCode创建SpringBoot项目(图文并茂)_vscode创建spring boot项目-CSDN博客</a></p>
<h2 id="9jenkinsgitlab">9、使用Jenkins拉取gitlab代码</h2>
<h4 id="91-git">9.1 创建一个自由风格的项目，并且在源码管理中添加git</h4>
<p><img alt="image-20250828142215682" src="../DevOps.assets/image-20250828142215682.png" /></p>
<h4 id="92-gitlab">9.2 点击立即构建，把gitlab仓库的代码拉到本地</h4>
<p><img alt="image-20250828142357856" src="../DevOps.assets/image-20250828142357856.png" /></p>
<p><img alt="image-20250828142628214" src="../DevOps.assets/image-20250828142628214.png" /></p>
<p>可以在Jenkins服务器的data/workspace中查看到</p>
<p><img alt="image-20250828142534484" src="../DevOps.assets/image-20250828142534484.png" /></p>
<h2 id="10gitlab">10、在拉取gitlab代码的同时，推送到目标服务器</h2>
<h4 id="101">10.1 添加构建操作</h4>
<p>使用已安装的maven</p>
<p><img alt="image-20250828143002360" src="../DevOps.assets/image-20250828143002360.png" /></p>
<h4 id="102">10.2 点击立即构建</h4>
<p><img alt="image-20250828143726068" src="../DevOps.assets/image-20250828143726068.png" /></p>
<p><img alt="image-20250828143816318" src="../DevOps.assets/image-20250828143816318.png" /></p>
<h4 id="103-jark8s">10.3 添加构建后操作-把jar包推送到k8s服务器</h4>
<p><img alt="image-20250828144043620" src="../DevOps.assets/image-20250828144043620.png" /></p>
<h4 id="104-k8s">10.4 登录k8s服务器查看目标文件</h4>
<p><img alt="image-20250828144349059" src="../DevOps.assets/image-20250828144349059.png" /></p>
<h4 id="105-docker-compose">10.5 使用docker-compose的方式发布服务</h4>
<pre><code class="language-shell"># 在项目中创建docker目录，并创建Dockerfile文件和docker-compose.yaml文件

# Dockerfile
FROM eclipse-temurin:17-jdk-jammy
COPY mytest.jar /usr/local/
WORKDIR /usr/local
CMD java -jar mytest.jar

# docker-compose.yaml
services:
  mytest:
    build: 
      context: ./
      dockerfile: Dockerfile
    image: mytest:v1.0.0
    container_name: mytest
    ports:
      - 8081:8080
</code></pre>
<p>Jenkins配置构建后操作</p>
<p><img alt="image-20250828151757249" src="../DevOps.assets/image-20250828151757249.png" /></p>
<p>点击立即构建之后，浏览器访问服务</p>
<p><img alt="image-20250828151823801" src="../DevOps.assets/image-20250828151823801.png" /></p>
<h2 id="11jenkins">11、Jenkins基于参数构建</h2>
<p><img alt="image-20250828152805026" src="../DevOps.assets/image-20250828152805026.png" /><img alt="image-20250828152822988" src="../DevOps.assets/image-20250828152822988.png" /></p>
<h2 id="12jenkinsdocker">12、Jenkins容器内部使用Docker</h2>
<pre><code class="language-shell"># 找到docker.sock文件，把所属组改成root。给其他人添加读和写权限
cd /run/
chown root:root docker.sock
chmod o+rw docker.sock

[root@jenkins-31-171 jenkins_docker]# cat docker-compose.yaml
services:
  jenkins:
    image: jenkins/jenkins:2.462.3-lts
    container_name: jenkins
    ports:
      - 8080:8080
      - 50000:50000
    volumes:
      - ./data/:/var/jenkins_home/
      - /run/docker.sock:/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker
      - /etc/docker/daemon.json:/etc/docker/daemon.json

</code></pre>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Docker%20%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Docker%20%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="btn btn-xs btn-link">
        Docker 常用命令
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../.." class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../.." class="btn btn-xs btn-link">
        首页
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content"><p>Copyright &copy; 2025 WeiZhiwang | 
<a href="https://github.com/weizhiwang221/cloud-native-journey" target="_blank" rel="noopener">View on GitHub</a>
</p>
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>